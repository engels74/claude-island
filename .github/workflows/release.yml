name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (without v prefix)'
        required: true

jobs:
  build:
    runs-on: macos-15  # Use macos-15 for Xcode 16.x support (macos-latest becomes macos-15 in Aug 2025)

    outputs:
      version: ${{ steps.version.outputs.version }}
      dmg_size: ${{ steps.dmg-info.outputs.size }}
      ed_signature: ${{ steps.dmg-info.outputs.signature }}
      min_system: ${{ steps.dmg-info.outputs.min_system }}
      has_sparkle: ${{ steps.sparkle-key.outputs.has_key }}

    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build with ad-hoc signing
        run: ./scripts/build.sh

      - name: Install create-dmg
        run: brew install create-dmg || true

      - name: Setup Sparkle key
        id: sparkle-key
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          if [ -n "$SPARKLE_PRIVATE_KEY" ]; then
            mkdir -p .sparkle-keys
            echo "$SPARKLE_PRIVATE_KEY" > .sparkle-keys/eddsa_private_key
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Sparkle private key configured"
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SPARKLE_PRIVATE_KEY secret not set - Sparkle signing will be skipped"
          fi

      - name: Create DMG and sign with Sparkle
        run: |
          SPARKLE_FLAG=""
          if [ "${{ steps.sparkle-key.outputs.has_key }}" != "true" ]; then
            SPARKLE_FLAG="--skip-sparkle"
          fi
          ./scripts/create-release.sh --skip-notarization --skip-github --skip-website $SPARKLE_FLAG

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Get DMG info
        id: dmg-info
        if: steps.sparkle-key.outputs.has_key == 'true'
        run: |
          DMG_PATH="releases/ClaudeIsland-${{ steps.version.outputs.version }}.dmg"
          SIZE=$(stat -f%z "$DMG_PATH")
          echo "size=$SIZE" >> $GITHUB_OUTPUT

          # Extract signature from generated appcast
          if [ -f "releases/appcast/appcast.xml" ]; then
            # Use grep with || true to avoid pipefail failure when no match exists
            SIG=$(grep -oE 'sparkle:edSignature="[^"]+"' releases/appcast/appcast.xml 2>/dev/null | head -1 | sed 's/sparkle:edSignature="//;s/"$//' || true)
            if [ -n "$SIG" ]; then
              echo "signature=$SIG" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è No EdDSA signature found in appcast.xml"
            fi
          fi

          # Get minimum system version from Info.plist
          MIN_SYS=$(/usr/libexec/PlistBuddy -c "Print :LSMinimumSystemVersion" "build/export/Claude Island.app/Contents/Info.plist" 2>/dev/null || echo "15.6")
          echo "min_system=$MIN_SYS" >> $GITHUB_OUTPUT

      - name: Output build info
        if: steps.sparkle-key.outputs.has_key == 'true'
        run: |
          echo "### Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- DMG Size: ${{ steps.dmg-info.outputs.size }} bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Has Signature: ${{ steps.dmg-info.outputs.signature != '' }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-dmg
          path: releases/ClaudeIsland-${{ steps.version.outputs.version }}.dmg
          retention-days: 7

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: releases/ClaudeIsland-${{ steps.version.outputs.version }}.dmg
          body: |
            ## Claude Island v${{ steps.version.outputs.version }}

            ### Installation

            **First Launch (Required):** macOS will block this app since it's not notarized.

            **Option 1 (GUI):**
            1. Download the DMG and drag Claude Island to Applications
            2. Try to open ‚Äî it will be blocked
            3. Go to **System Settings ‚Üí Privacy & Security**
            4. Find "Claude Island was blocked" and click **Open Anyway**

            **Option 2 (Terminal):**
            ```bash
            xattr -d com.apple.quarantine "/Applications/Claude Island.app"
            ```

            ### Auto-updates
            After first launch, auto-updates via Sparkle work normally.

      - name: Upload appcast artifact
        if: steps.sparkle-key.outputs.has_key == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: appcast
          path: releases/appcast/appcast.xml

  virustotal-scan:
    name: VirusTotal Scan
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@v7
        with:
          name: release-dmg

      - name: Scan with VirusTotal
        uses: crazy-max/ghaction-virustotal@v4
        id: virustotal
        with:
          vt_api_key: ${{ secrets.VT_API_KEY }}
          request_rate: 4
          files: |
            *.dmg

      - name: Create scan results summary
        run: |
          # Build the markdown content
          {
            echo "## üõ°Ô∏è VirusTotal Scan Results"
            echo ""
            echo "**Scan completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### Analysis Reports"
            echo ""
            echo "| File | Report |"
            echo "|------|--------|"
            # Output format is comma-separated "filename=url" pairs
            IFS=',' read -ra PAIRS <<< "${{ steps.virustotal.outputs.analysis }}"
            for pair in "${PAIRS[@]}"; do
              filename="${pair%%=*}"
              url="${pair#*=}"
              echo "| üì¶ \`${filename}\` | [View VirusTotal Report](${url}) |"
            done
            echo ""
            echo "---"
            echo ""
            echo "_Click the links above to view full analysis on VirusTotal._"
          } | tee virustotal-results.md >> $GITHUB_STEP_SUMMARY

      - name: Upload scan results
        uses: actions/upload-artifact@v6
        with:
          name: virustotal-results
          path: virustotal-results.md
          retention-days: 90

  update-website:
    name: Update Website Appcast
    needs: build
    runs-on: ubuntu-latest
    # Only run if Sparkle signing was configured AND signature was actually generated
    if: needs.build.outputs.has_sparkle == 'true' && needs.build.outputs.ed_signature != ''

    steps:
      - name: Trigger website appcast update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WEBSITE_PAT }}
          repository: engels74/claude-island-web
          event-type: update-appcast
          client-payload: |
            {
              "version": "${{ needs.build.outputs.version }}",
              "download_url": "https://github.com/engels74/claude-island/releases/download/v${{ needs.build.outputs.version }}/ClaudeIsland-${{ needs.build.outputs.version }}.dmg",
              "ed_signature": "${{ needs.build.outputs.ed_signature }}",
              "file_size": "${{ needs.build.outputs.dmg_size }}",
              "min_system_version": "${{ needs.build.outputs.min_system }}"
            }
