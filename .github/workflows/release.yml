name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (without v prefix)'
        required: true

jobs:
  build:
    runs-on: macos-15  # Use macos-15 for Xcode 16.x support (macos-latest becomes macos-15 in Aug 2025)

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v6

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build with ad-hoc signing
        run: ./scripts/build.sh

      - name: Install create-dmg
        run: brew install create-dmg || true

      - name: Setup Sparkle key
        id: sparkle-key
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          if [ -n "$SPARKLE_PRIVATE_KEY" ]; then
            mkdir -p .sparkle-keys
            echo "$SPARKLE_PRIVATE_KEY" > .sparkle-keys/eddsa_private_key
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Sparkle private key configured"
          else
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SPARKLE_PRIVATE_KEY secret not set - Sparkle signing will be skipped"
          fi

      - name: Create DMG and sign with Sparkle
        run: |
          SPARKLE_FLAG=""
          if [ "${{ steps.sparkle-key.outputs.has_key }}" != "true" ]; then
            SPARKLE_FLAG="--skip-sparkle"
          fi
          ./scripts/create-release.sh --skip-notarization --skip-github --skip-website $SPARKLE_FLAG

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-dmg
          path: releases/ClaudeIsland-${{ steps.version.outputs.version }}.dmg
          retention-days: 7

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: releases/ClaudeIsland-${{ steps.version.outputs.version }}.dmg
          body: |
            ## Claude Island v${{ steps.version.outputs.version }}

            ### Installation

            **First Launch (Required):** macOS will block this app since it's not notarized.

            **Option 1 (GUI):**
            1. Download the DMG and drag Claude Island to Applications
            2. Try to open ‚Äî it will be blocked
            3. Go to **System Settings ‚Üí Privacy & Security**
            4. Find "Claude Island was blocked" and click **Open Anyway**

            **Option 2 (Terminal):**
            ```bash
            xattr -d com.apple.quarantine "/Applications/Claude Island.app"
            ```

            ### Auto-updates
            After first launch, auto-updates via Sparkle work normally.

      - name: Upload appcast artifact
        if: steps.sparkle-key.outputs.has_key == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: appcast
          path: releases/appcast/appcast.xml

  virustotal-scan:
    name: VirusTotal Scan
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@v7
        with:
          name: release-dmg

      - name: Scan with VirusTotal
        uses: crazy-max/ghaction-virustotal@v4
        id: virustotal
        with:
          vt_api_key: ${{ secrets.VT_API_KEY }}
          request_rate: 4
          files: |
            *.dmg

      - name: Create scan results summary
        run: |
          # Build the markdown content
          {
            echo "## üõ°Ô∏è VirusTotal Scan Results"
            echo ""
            echo "**Scan completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "### Analysis Reports"
            echo ""
            # Output format is comma-separated "filename=url" pairs
            IFS=',' read -ra PAIRS <<< "${{ steps.virustotal.outputs.analysis }}"
            for pair in "${PAIRS[@]}"; do
              filename="${pair%%=*}"
              url="${pair#*=}"
              echo "| üì¶ \`${filename}\` | [View VirusTotal Report](${url}) |"
            done
            echo ""
            echo "---"
            echo ""
            echo "_Click the links above to view full analysis on VirusTotal._"
          } | tee virustotal-results.md >> $GITHUB_STEP_SUMMARY

      - name: Upload scan results
        uses: actions/upload-artifact@v6
        with:
          name: virustotal-results
          path: virustotal-results.md
          retention-days: 90
